<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Compiling and running the application</title><meta name="generator" content="DocBook XSL Stylesheets V1.75.1"><link rel="home" href="index.html" title="EyeDB Getting started"><link rel="up" href="ch04.html" title="Chapter 4. Using the C++ Binding"><link rel="prev" href="ch04s02.html" title="A minimal client program"><link rel="next" href="ch05.html" title="Chapter 5. Using the Java Binding"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Compiling and running the application</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch04s02.html">Prev</a> </td><th width="60%" align="center">Chapter 4. Using the C++ Binding</th><td width="20%" align="right"> <a accesskey="n" href="ch05.html">Next</a></td></tr></table><hr></div><div class="section" title="Compiling and running the application"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id301618"></a>Compiling and running the application</h2></div></div></div><p>
	To use this client, you must first compile it: <span class="command"><strong>eyedbodl</strong></span> has generated a makefile called <code class="filename">Makefile.&lt;&lt;package&gt;&gt;</code> which can be used as is or can help you to design your own makefile.
      </p><p>
	A template C++ file (<code class="filename">template_&lt;&lt;package&gt;&gt;.cc</code>) has also been generated, closed to the previous minimal client program, which can be compiled with the generated makefile.
      </p><p>
	<a class="xref" href="ch04s03.html#cxx-generated-makefile" title="Example 4.2. The Makefile generated by eyedbodl">Example 4.2, “The Makefile generated by <span class="command">eyedbodl</span>”</a> shows the generated <code class="filename">Makefile.person</code> (<code class="filename">&lt;&lt;datadir&gt;&gt;</code> is the data directory, usually <code class="filename">/usr/share</code>):
      </p><div class="example"><a name="cxx-generated-makefile"></a><p class="title"><b>Example 4.2. The Makefile generated by <span class="command">eyedbodl</span></b></p><div class="example-contents"><pre class="screen">
#
# Makefile.person
# 
# person package
#
# Example of template Makefile that can help you to compile
# the generated C++ file and the template program
# Generated by eyedbodl at Sat Jan 28 17:53:48 2006
#

include &lt;&lt;datadir&gt;&gt;/eyedb/Makefile.eyedb

CXXFLAGS += $(EYEDB_CXXFLAGS) $(EYEDB_CPPFLAGS)
LDFLAGS  += ${EYEDB_LDFLAGS}
LDLIBS   += ${EYEDB_LDLIBS}

# if you use gcc
GCC_FLAGS = -Wl,-R$(EYEDB_LIBDIR)

# Example for compiling a client program:

client_program = template_person

$(client_program): person.o $(client_program).o
        $(CXX) $(LDFLAGS) $(GCC_FLAGS) -o $@ $^ $(LDLIBS)

	</pre></div></div><br class="example-break"><p>
	Important note: you need a recent version of GNU make to use this makefile. This makefile does not work with the standard SUN make.
      </p><p>
	Once compiled, you can execute the program as follows:
	</p><div class="informalexample"><pre class="screen">
% ./persontest foo
	  </pre></div><p>
      </p><p>
	We are going now to add a function to manipulate <code class="classname">Person</code> instances:
	</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>create a person named "john wayne"</p></li><li class="listitem"><p>create a person named "mary poppins"</p></li><li class="listitem"><p>mary them</p></li><li class="listitem"><p>create 3 "john wayne" children named "baby1", "baby2" and "baby3"</p></li></ul></div><p>
      </p><p>
	These operations are performed in the function <code class="function">create</code>, listed in <a class="xref" href="ch04s03.html#cxx-create-function" title="Example 4.3. A C++ function to create objects">Example 4.3, “A C++ function to create objects”</a>
      </p><div class="example"><a name="cxx-create-function"></a><p class="title"><b>Example 4.3. A C++ function to create objects</b></p><div class="example-contents"><pre class="screen">
static void
create(eyedb::Database *db)
{
  db-&gt;transactionBegin(); // starts a new transaction

  Person *john = new Person(db);
  john-&gt;setFirstname("john");
  john-&gt;setLastname("wayne");
  john-&gt;setAge(32);
  john-&gt;getAddr()-&gt;setStreet("courcelles");
  john-&gt;getAddr()-&gt;setTown("Paris");

  Person *mary = new Person(db);
  mary-&gt;setFirstname("mary");
  mary-&gt;setLastname("poppins");
  mary-&gt;setAge(30);
  mary-&gt;getAddr()-&gt;setStreet("courcelles");
  mary-&gt;getAddr()-&gt;setTown("Paris");

  // mary them
  john-&gt;setSpouse(mary);

  // creates children
  for (int i = 0; i &lt; 5; i++) {
    std::string name = std::string("baby") + str_convert(i+1);
    Person *child = new Person(db);
    child-&gt;setFirstname(name.c_str());
    child-&gt;setLastname(name.c_str());
    child-&gt;setAge(1+i);
    john-&gt;addToChildrenColl(child);
    child-&gt;release(); // release the allocated pointer
  }

  // store john and all its related instances within the database
  john-&gt;store(eyedb::FullRecurs);

  // release the allocated pointers
  mary-&gt;release();
  john-&gt;release();

  db-&gt;transactionCommit(); // commits the current transaction
}

	</pre></div></div><br class="example-break"><p>
	A few remarks about this code:
	</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
	      all operations - setting, getting attributes, storing, querying instances	in a database - must be performed within a transaction.	A transaction is initiated using the <code class="function">Database::transactionBegin</code> method and is committed (resp. aborted) using the <code class="function">Database::transactionCommit</code> (resp. <code class="function">Database::transactionAbort</code>) method.
	    </p></li><li class="listitem"><p>
	      to store any instance in the database, you need to call the <code class="function">store</code> (or <code class="function">realize</code>) method on this instance. In our case, we use the argument <code class="varname">FullRecurs</code> indicating that we want all related instances (through relationship or indirect attribute) to be stored in the database.
	    </p></li><li class="listitem"><p>
	      all runtime pointers allocated with the <code class="function">new</code> operator must be deleted using the <code class="function">release</code> method. The <code class="function">delete</code> operator is forbidden: if you try to use it, an exception will be thrown at runtime.
	    </p></li></ul></div><p>
      </p><p>
	We are now going to query and display all the person instances. The corresponding code is given in <a class="xref" href="ch04s03.html#cxx-query-function" title="Example 4.4. A C++ function to query objects">Example 4.4, “A C++ function to query objects”</a>.
      </p><div class="example"><a name="cxx-query-function"></a><p class="title"><b>Example 4.4. A C++ function to query objects</b></p><div class="example-contents"><pre class="screen">
static void
read(eyedb::Database *db, const char *s)
{
  db-&gt;transactionBegin();

  eyedb::OQL q(db, "select Person.lastname ~ \"%s\"", s);

  eyedb::ObjectArray obj_arr;
  q.execute(obj_arr);

  for (int i = 0; i &lt; obj_arr.getCount(); i++) {
    Person *p = Person_c(obj_arr[i]);
    if (p)
      printf("person = %s %s, age = %d\n", p-&gt;getFirstname(),
             p-&gt;getLastname(), p-&gt;getAge());
  }

  db-&gt;transactionCommit();
}

	</pre></div></div><br class="example-break"><p>
	An OQL construct can be used within the C++ code using the <span class="command"><strong>OQL(Database *, const char *fmt, ...)</strong></span> constructor. For instance, in the above example, assuming <code class="varname">s</code> is equal to <code class="varname">baby</code>, the following code will send the query <span class="command"><strong>select Person.lastname ~ "baby"</strong></span> to the OQL interpreter:
	</p><div class="informalexample"><pre class="programlisting">
eyedb::OQL q(db, "select Person.lastname ~ \"%s\"", s);
	  </pre></div><p>
      </p><p>
	This interpreter will perform the query and returned all the found objects. The returned objects can be found using the <code class="function">OQL::execute</code> method as follows:
	</p><div class="informalexample"><pre class="programlisting">
  eyedb::ObjectArray obj_arr;
  q.execute(obj_arr);
	  </pre></div><p>
      </p><p>
	The returned objects are of type <code class="classname">eyedb::Object</code>, so you cannot use the <code class="classname">Person</code> methods such as <code class="function">getFirstname()</code>, <code class="classname">getAge()</code>\ldots To use them, you need to perform a down-cast using the <code class="classname">Person\_c</code> static function as follows:
	</p><div class="informalexample"><pre class="programlisting">
  for (int i = 0; i &lt; obj_arr.getCount(); i++) {
    Person *p = Person_c(obj_arr[i]);
    if (p) ...
	  </pre></div><p>
      </p><p>
	If the object <code class="varname">obj_arr[i]</code> is not of type <code class="classname">Person</code>, the returned pointer will be null. It is why we make a test on the value of <code class="varname">p</code>. If <code class="classname">p</code> is not null, we can use all the <code class="classname">Person</code> methods as follows:
	</p><div class="informalexample"><pre class="programlisting">
	    printf("person = %s %s, age = %d\n", p-&gt;getFirstname(),
	    p-&gt;getLastname(), p-&gt;getAge());
	  </pre></div><p>
      </p><p>
	To have more information about the C++ binding, please refer to the EyeDB C++ binding manual.
      </p></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch04s02.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="ch04.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="ch05.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">A minimal client program </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 5. Using the Java Binding</td></tr></table></div></body></html>
